import express, { Request, Response } from 'express';
import mongoose from 'mongoose';
import cors from 'cors';
import dotenv from 'dotenv';
import cookieParser from 'cookie-parser';
import path from 'path';
import bodyParser from 'body-parser';
import fs from 'fs';
import { IncomingMessage } from 'http';

// à¹‚à¸«à¸¥à¸”à¸„à¹ˆà¸² .env
dotenv.config();

const app = express();
const port = parseInt(process.env.PORT || '3000', 10);
const mongoURI = process.env.MONGODB_URI as string;

// ========================================================
// ðŸ§  Step 1: à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š & Copy à¸£à¸¹à¸›à¸ˆà¸²à¸ image â†’ volume à¸–à¹‰à¸²à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹€à¸„à¸¢à¸¡à¸µ
// ========================================================
const volumePath = path.join(__dirname, '../uploads');            // à¸—à¸µà¹ˆ mount volume à¸ˆà¸£à¸´à¸‡
const backupPath = path.join(__dirname, '../uploads-backup');    // à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆà¹ƒà¸™ image
const checkFolder = path.join(volumePath, 'products');
const isFolderEmpty = fs.existsSync(checkFolder) && fs.readdirSync(checkFolder).length === 0;

if (!fs.existsSync(checkFolder) || isFolderEmpty) {
  console.log('ðŸ“¦ uploads/ à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸«à¸£à¸·à¸­à¸§à¹ˆà¸²à¸‡à¹€à¸›à¸¥à¹ˆà¸² â†’ Copy à¸£à¸¹à¸›à¸•à¸±à¹‰à¸‡à¸•à¹‰à¸™à¸ˆà¸²à¸ uploads-backup...');
  try {
    fs.cpSync(backupPath, volumePath, { recursive: true });
    console.log('âœ… Copy à¸£à¸¹à¸›à¸ªà¸´à¸™à¸„à¹‰à¸²à¸•à¸±à¹‰à¸‡à¸•à¹‰à¸™à¸ªà¸³à¹€à¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§');
  } catch (err) {
    console.error('âŒ Copy uploads failed:', err);
  }
} else {
  console.log('âœ… à¸žà¸š uploads à¹à¸¥à¹‰à¸§ â†’ à¸‚à¹‰à¸²à¸¡à¸à¸²à¸£ Copy');
}

// ========================================================
// ðŸŒ Middleware
// ========================================================
app.use(cors({
  origin: [
    'http://localhost:5173',
    'http://localhost:5174',
    'https://benjaphan5.com',
    'https://admin-dashboard.benjaphan5.com',
  ],
  credentials: true              
}));
app.use(cookieParser());
app.use(bodyParser.json({
  type: (req: IncomingMessage) =>
    req.headers['content-type']?.includes('application/json') || false
}));
app.set('trust proxy', true);

// ========================================================
// ðŸ”Œ Connect MongoDB
// ========================================================
mongoose.connect(mongoURI)
  .then(() => console.log('âœ… Connected to MongoDB successfully'))
  .catch((error) => console.error('âŒ MongoDB connection error:', error));

// ========================================================
// ðŸ§ª Test route
// ========================================================
app.get('/', (_req, res) => {
  res.send('ðŸŽ‰ Hello from E-commerce Backend with Yarn + MongoDB!');
});

// ========================================================
// ðŸ§© Import & Use Routes
// ========================================================
import auth from './routes/auth.route';
import user from './routes/user.route';
import product from './routes/product.route';
import article from './routes/article.route';
import cart from './routes/cart.route';
import wishlist from './routes/wishlist.route';
import review from './routes/review.route';
import order from './routes/order.route';
import contact from './routes/contact.route';
import notification from './routes/notification.route';
import setting from './routes/setting.route';

app.use('/api/auth', auth);
app.use('/api/user', user);
app.use('/api/product', product);
app.use('/api/article', article);
app.use('/api/cart', cart);
app.use('/api/wishlist', wishlist);
app.use('/api/review', review);
app.use('/api/order', order);
app.use('/api/contact', contact);
app.use('/api/notifications', notification);
app.use('/api/setting', setting);

// ========================================================
// ðŸ“‚ Serve Static Files
// ========================================================
app.use('/uploads', express.static(path.join(__dirname, '../uploads')));

// ========================================================
// ðŸš€ Start Server
// ========================================================
app.listen(port, '0.0.0.0', () => {
  console.log(`ðŸš€ Server is running at http://localhost:${port}`);
});
